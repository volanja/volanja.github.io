<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on volanja Pages</title><link>https://volanja.github.io/post/</link><description>Recent content in Posts on volanja Pages</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 25 Jul 2021 18:20:00 +0900</lastBuildDate><atom:link href="https://volanja.github.io/post/index.xml" rel="self" type="application/rss+xml"/><item><title>Conftestでのtraceによるデバッグ</title><link>https://volanja.github.io/p/conftest-debug-trace/</link><pubDate>Sun, 25 Jul 2021 18:20:00 +0900</pubDate><guid>https://volanja.github.io/p/conftest-debug-trace/</guid><description>最近、Conftestを勉強し始めたところ、デバッグ用のtraceの挙動で悩んだので使い方と注意点を記載する。
Conftestを簡単に説明すると、ConftestとはYAMLやJSONなどの構造化データに対するテストを作成するツールである。
例えばk8sの設定ファイルのテストなどに使われていて、テストはOpenPolicyAgent(OPA)のRego言語を用いて記述する。
(Regoは&amp;quot;ray-go&amp;quot;と発音するので、日本語では&amp;quot;レイゴー&amp;quot;)
trace の使い方 ConftestのRego言語ではデバッグのためにtraceをコード内に埋め込み、表示させることができる。
OpenPolicyAgent - Policy Reference - Built-in Functions - Debugging
コード traceで文字列を表示させる場合は引数として文字列を渡す。
trace(&amp;#34;Hello&amp;#34;) 変数を埋め込みたい場合はsprintfを使う。
trace(sprintf(&amp;#34;foo: %v&amp;#34;, [input.foo])) sprintfの第二引数には変数を指定できるが、変数には[]が必要である。
(変数に[]をつけない場合の動作は後述。)
実行方法 traceを表示するにはconftest testやconftest verifyに--traceを追加して実行する。
traceの注意点 おさらい traceの注意点の前にRego言語の構文と名前についておさらいする。
Regoの構文では、ルール(Rules)のbodyに式(expression)を置く。
式は結果がtrueになるように記載し、全ての式がtrueの場合はルールが成功する。 次のように式が２行ある場合は論理積(Logical AND)として処理されるので、
2つの式の結果がtrueであれば、ルールは成功となる。 逆に式の結果のどちらかがfalseであれば、ルールは失敗となるし、
式の結果がfalseだった時点でルールの処理が中断され、falseだった式以降は処理されない。 deny[msg] { #ルール(Rules)のhead #ルール(Rules)のbody input.foo == &amp;#34;one&amp;#34; #式(expression) input.bar == &amp;#34;second&amp;#34; #式(expression) msg := &amp;#34;Output trace message.&amp;#34; #変数(variables) } 注意点 OPAのドキュメントでは明確に書かれていないように見えるが、
traceは式(expression)の1つであるため、traceを表示するには次の注意点がある。
traceより前の式(expression)の結果で、traceの出力が変わる。
例えば、traceより前の式の結果がtrue なら、式のあとのtraceは表示される。
一方で、traceより前の式の結果がfalseなら、式のあとのtraceは表示されない。
これはtraceより前の式の結果がfalseだった時点でルールの評価が中断され、ルールが失敗するため。 trace内のsprintfの第二引数に存在しない変数を指定した場合や変数に[]をつけ忘れた場合、ルールが失敗する。</description></item><item><title>govcでESXi 6.7u3から情報取得する。</title><link>https://volanja.github.io/p/vmw-govc-got-info-from-esxi67u3/</link><pubDate>Sun, 13 Jun 2021 21:32:02 +0900</pubDate><guid>https://volanja.github.io/p/vmw-govc-got-info-from-esxi67u3/</guid><description>前提 ESXi 6.7u3をVirtual Boxにて以下の通り構築した。
ESXi 6.7u3 (Build:14320388) Storage datastore1 pNIC vmnic0 vmnic1 vSwtich vSwitch0 Uplink: vmnic0 vSwitch1 Uplink: vmnic1 PortGroup Management Network vSwitch: vSwitch0 VM Network vSwitch: vSwitch0 VM Network2 vSwitch: vSwitch1 Virtual Machine Windows Server 2019 PortGoup: VM Network OS is not install.</description></item><item><title>govcでvcsimから情報取得する。</title><link>https://volanja.github.io/p/vmw-govc-got-info-from-vcsim/</link><pubDate>Sun, 13 Jun 2021 21:25:42 +0900</pubDate><guid>https://volanja.github.io/p/vmw-govc-got-info-from-vcsim/</guid><description>前提 vcsimをデフォルト起動した。
$ vcsim コマンド実行結果 環境変数 $ govc env GOVC_USERNAME=user GOVC_PASSWORD=pass GOVC_URL=127.0.0.1:8989 GOVC_INSECURE=1 About 接続先の情報
$ govc about Name: VMware vCenter Server (govmomi simulator) Vendor: VMware, Inc. Version: 6.5.0 Build: 5973321 OS type: darwin-amd64 API type: VirtualCenter API version: 6.5 Product ID: vpx UUID: dbed6e0c-bd88-4ef6-b594-21283e1c677f $ find $ govc find / /DC0 /DC0/vm /DC0/vm/DC0_H0_VM0 /DC0/vm/DC0_H0_VM1 /DC0/vm/DC0_C0_RP0_VM0 /DC0/vm/DC0_C0_RP0_VM1 /DC0/host /DC0/host/DC0_H0 /DC0/host/DC0_H0/DC0_H0 /DC0/host/DC0_H0/Resources /DC0/host/DC0_C0 /DC0/host/DC0_C0/DC0_C0_H0 /DC0/host/DC0_C0/DC0_C0_H1 /DC0/host/DC0_C0/DC0_C0_H2 /DC0/host/DC0_C0/Resources /DC0/datastore /DC0/datastore/LocalDS_0 /DC0/network /DC0/network/VM Network /DC0/network/DVS0 /DC0/network/DVS0-DVUplinks-9 /DC0/network/DC0_DVPG0 $ datacenter.</description></item><item><title>Starting govc</title><link>https://volanja.github.io/p/vmw-starting-govc/</link><pubDate>Sun, 13 Jun 2021 19:10:18 +0900</pubDate><guid>https://volanja.github.io/p/vmw-starting-govc/</guid><description>VMware govcとは Go言語で書かれたAPI Client
https://github.com/vmware/govmomi/blob/master/govc/README.md
VMware vSphere APIのためのGo言語ライブラリであるgovmomiに含まれる。
そのほかにgovmomiは以下のソフトウェアを含む。
vcsim
Go言語で書かれたvSphere Simulator 執筆時点の環境 $ govc version -l Build Version: 0.25.0 Build Commit: bb0307eb Build Date: 2021-04-16T16:00:59Z 設定 govcの環境変数設定 govcからvCenterやESXi, vcsimにアクセスするには環境変数を設定する。
$ govc env GOVC_USERNAME=root GOVC_PASSWORD=VMware1! GOVC_URL=192.168.100.120 例えばvcsimにアクセスするにはvcsim起動後に表示されるexportコマンドを実行して、環境変数を設定する。
export GOVC_URL=https://user:pass@127.0.0.1:8989/sdk GOVC_SIM_PID=42915 govcのTips サーバ証明書の検証エラー govc実行時に何も指定しないとサーバ証明書の検証エラーが出る。
$ govc host.info /DC0/host/DC0_H0 govc: Post &amp;quot;https://127.0.0.1:8989/sdk&amp;quot;: x509: certificate signed by unknown authority -kをつけると検証をスキップする。
$ govc host.info --help Usage: govc host.info [OPTIONS] Options: -k=false Skip verification of server certificate [GOVC_INSECURE] 毎回-kを付けるのは手間がかかり忘れがちなので環境変数にオプションを設定する。</description></item><item><title>Starting vcsim</title><link>https://volanja.github.io/p/vmw-starting-vcsim/</link><pubDate>Sun, 13 Jun 2021 19:10:18 +0900</pubDate><guid>https://volanja.github.io/p/vmw-starting-vcsim/</guid><description>VMware vcsimとは Go言語で書かれたvSphere Simulator
https://github.com/vmware/govmomi/blob/master/vcsim/README.md
VMware vSphere APIのためのGo言語ライブラリであるgovmomiに含まれる。
そのほかにgovmomiは以下のソフトウェアを含む。
govc
Go言語で書かれたAPI Client 利用用途 govcのテスト用シミュレーター Ansible moduleのテスト用シミュレーター など 執筆時点の環境 $ vcsim version Build Version: 0.25.0 Build Commit: bb0307eb Build Date: 2021-04-16T16:00:59Z vcsimの起動 デフォルト デフォルトではデータセンター1個、ホスト3台、仮想マシン4台の環境を構築する。
$ vcsim export GOVC_URL=https://user:pass@127.0.0.1:8989/sdk GOVC_SIM_PID=42915 ESXi 1台のみ -esxを追加することでESXi 1台のみも構築できる。
$ vcsim -esx export GOVC_URL=https://user:pass@127.0.0.1:8989/sdk GOVC_SIM_PID=42917 govcからのアクセス vcsim起動後に表示される次のコマンドを実行する。
export GOVC_URL=https://user:pass@127.0.0.1:8989/sdk GOVC_SIM_PID=42917 詳細はStarting govcを参照のこと。
参考 vcsim help $ vcsim --help Usage of /Users/volanja/local/go/bin/vcsim: -E string Output vcsim variables to the given fifo or stdout (default &amp;quot;-&amp;quot;) -api-version string API version (default &amp;quot;6.</description></item></channel></rss>